<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="stylesheet.css">
    <title>Egg Beater</title>

    <script>
        "use strict";

		window.onload = init;

		// SCRIPT SCOPED VARIABLES

		// 1- here we are faking an enumeration - we'll look at another way to do this soon
		const SOUND_PATH = Object.freeze({
			sound1: "testAudio/New Adventure Theme.mp3",
			sound2: "testAudio/Peanuts Theme.mp3",
			sound3:  "testAudio/The Picard Song.mp3"
		});

		 //Canvas variables
        let canvasElement, drawCtx;
        //Audio variables
        let audioElement, audioCtx;
        //node variables
        let sourceNode, analyserNode, gainNode;
        //array to hold audio frequency data
        const NUM_SAMPLES = 256;
        //array of 8-bit int (0-255)
        let audioData = new Uint8Array(NUM_SAMPLES / 2);
        //UI variables
        let playButton;

		//these help with pixel effects
		let invert = false, noise = false, sepia = false;

        //delay variables
        var delayAmount = 0.5;
        var delayNode;

        let rooster = new Image();
        rooster.src = 'images/martha.png';

		// FUNCTIONS
		function init(){
			setupWebaudio();
			setupCanvas();
			setupUI();
			update();

		}

		function setupWebaudio(){
			// 1 - The || is because WebAudio has not been standardized across browsers yet
			const AudioContext = window.AudioContext || window.webkitAudioContext;
			audioCtx = new AudioContext();

			// 2 - get a reference to the <audio> element on the page
			audioElement = document.querySelector("audio");
			audioElement.src = SOUND_PATH.sound3;

			// 3 - create an a source node that points at the <audio> element
			sourceNode = audioCtx.createMediaElementSource(audioElement);

			// 4 - create an analyser node
			analyserNode = audioCtx.createAnalyser();


			// fft stands for Fast Fourier Transform
			analyserNode.fftSize = NUM_SAMPLES;

			// 5 - create a gain (volume) node
			gainNode = audioCtx.createGain();
			gainNode.gain.value = 1;

            //create DelayNode instance
            delayNode = audioCtx.createDelay();
            delayNode.delayTime.value = delayAmount;

//			// 6 - connect the nodes - we now have an audio graph
//			sourceNode.connect(analyserNode);
//			analyserNode.connect(gainNode);
//			gainNode.connect(audioCtx.destination);

            sourceNode.connect(audioCtx.destination);
            //this channel will play and visualize the delay
            sourceNode.connect(delayNode);
            delayNode.connect(analyserNode);
            analyserNode.connect(audioCtx.destination);
		}

		function setupCanvas(){
			canvasElement = document.querySelector('canvas');
			drawCtx = canvasElement.getContext("2d");
		}

		function setupUI(){
            /*
            3 sliders: Volume, Reverb, Brightness
            3 checkboxes: invert, sepia, noise
            radio: different pride flags
            Button: make it gay
            */

            //PLAY BUTTON
			playButton = document.querySelector("#playButton");
			playButton.onclick = e => {
				console.log(`audioCtx.state = ${audioCtx.state}`);

				// check if context is in suspended state (autoplay policy)
				if (audioCtx.state == "suspended") {
					audioCtx.resume();
				}

				if (e.target.dataset.playing == "no") {
					audioElement.play();
					e.target.dataset.playing = "yes";
				// if track is playing pause it
				} else if (e.target.dataset.playing == "yes") {
					audioElement.pause();
					e.target.dataset.playing = "no";
				}

			};

            //FULL SCREEN BUTTON
            document.querySelector("#fsButton").onclick = _ =>{
            requestFullscreen(canvasElement);
			};

            //AUDIO TRACK SELECTOR
            document.querySelector("#trackSelect").onchange = e =>{
            audioElement.src = e.target.value;
            // pause the current track if it is playing
            playButton.dispatchEvent(new MouseEvent("click"));
			};

			// if track ends
			audioElement.onended =  _ => {
				playButton.dataset.playing = "no";
			};

            //VOLUME SLIDER
			let volumeSlider = document.querySelector("#volumeSlider");
			volumeSlider.oninput = e => {
				gainNode.gain.value = e.target.value;
				volumeLabel.innerHTML = Math.round((e.target.value/2 * 100));
			};

            //DELAY SLIDER
            let delaySlider = document.querySelector("#delaySlider");
            delaySlider.oninput = e =>{
                delayAmount = e.target.value;
                delayLabel.innerHTML = e.target.value;
            }
			volumeSlider.dispatchEvent(new InputEvent("input"));

            //CHECKBOX ACTIVATION
            document.getElementById('invert').onchange = function(e){
                if(e.target.checked){
                    invert = true;
                }
                else{
                    invert = false;
                }
            }
            document.getElementById('noise').onchange = function(e){
                if(e.target.checked){
                    noise = true;
                }
                else{
                    noise = false;
                }
            }
            document.getElementById('sepia').onchange = function(e){
                if(e.target.checked){
                    sepia = true;
                }
                else{
                    sepia = false;
                }
            }


		}

		function update() {
			// this schedules a call to the update() method in 1/60 seconds
			requestAnimationFrame(update);

			// populate the audioData with the frequency data
			// notice these arrays are passed "by reference"
			analyserNode.getByteFrequencyData(audioData);

			// DRAW!
			drawCtx.clearRect(0,0,800,600);

            drawCtx.drawImage(rooster, canvasElement.width - 150, canvasElement.height - 150, 150, 150);

            let barWidth = 4;
            let barSpacing = 1;
            let barHeight = 100;
            let topSpacing = 525;

            for(let i = 0; i < audioData.length; i++){
                drawCtx.beginPath();
                drawCtx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                drawCtx.save();
                drawCtx.scale(.75, 1);
                drawCtx.arc(750 - i * (barHeight + barSpacing), topSpacing - audioData[i] * 0.5, barHeight - 75, 0, 2*Math.PI, false);
                drawCtx.fill();
                drawCtx.stroke();
                drawCtx.closePath();
                drawCtx.restore();
            }
            manipulatePixels(drawCtx);
            delayNode.delayTime.value = delayAmount;
		}



		// HELPER FUNCTIONS
		function requestFullscreen(element) {
			if (element.requestFullscreen) {
			  element.requestFullscreen();
			} else if (element.mozRequestFullscreen) {
			  element.mozRequestFullscreen();
			} else if (element.mozRequestFullScreen) { // camel-cased 'S' was changed to 's' in spec
			  element.mozRequestFullScreen();
			} else if (element.webkitRequestFullscreen) {
			  element.webkitRequestFullscreen();
			}
			// .. and do nothing if the method is not supported
		};

        function manipulatePixels(ctx){
             //get all rgba pixel data of the canvas by grabbing the ImageData Object
            let imageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);

            //imageData.data is an 8-bit typed array - values range from 0-255
            //imageData.data contains 4 values per pixel: 4 x canvas.width x canvas.height = 1,024,00 values
            let data = imageData.data;
            let length = data.length;
            let width = imageData.width;

            for(let i = 0; i < length; i += 4){
                //invert
                if(invert){
                    let red = data[i], green = data[i+1], blue = data[i+2];
                    data[i] = 255 - red; //set red value
                    data[i+1] = 255 - green; //set blue;
                    data[i+2] = 255 - blue; //set green
                }

                //noise
                if(noise && Math.random() < .10){
                    data[i] = data[i + 1] = data [i+2] = 128; //gray noise
                    //data[i] = data[i + 1] = data [i+2] = 255; //white
                    //data[i] = data[i + 1] = data [i+2] = 0; //black
                    data[i + 3] = 255; //alpha

                }

                //sepia
                if(sepia){
                   data[i] = (data[i] * .393) + (data[i + 1] * .769) + (data[i+2] * .189);
                   data[i+1] = (data[i] * .349) + (data[i + 1] * .686) + (data[i+2] * .168);
                   data[i+2] = (data[i] * .272) + (data[i + 1] * .534) + (data[i+2] * .131);
                }
            }
            //put motified data back on the canvas
            ctx.putImageData(imageData, 0, 0);
        }

    </script>
</head>

<body>
    <div id="grid-container">
        <div id="container">
            <canvas width="750" height="550"></canvas>
            <div id="controls">
                <audio></audio>

                <!-- CHOOSE AUDIO-->
                <section>
                    <label>Track:
                        <select id="trackSelect">
                            <option value="testAudio/New Adventure Theme.mp3">New Adventure Theme</option>
                            <option value="testAudio/Peanuts Theme.mp3">Peanuts Theme</option>
                            <option value="testAudio/The Picard Song.mp3" selected>The Picard Song</option>
                        </select>
                    </label>

                    <!--PLAY BUTTON-->
                    <button id="playButton" data-playing="no"></button>
                    <!--FULL SCREEN-->
                    <button id="fsButton">Full Screen</button>
                </section>

                <!--SLIDERS-->
                <section class="effectBox">
                    <span>Sound Effects</span>
                    <!--VOLUME SLIDER-->
                    <section class="sliders">
                        Volume: <input type="range" id="volumeSlider" min="0" max="2" value="1" step="0.01">
                        <span id="volumeLabel">???</span>
                    </section>
                    <!--REVERB SLIDER-->
                    <section class="sliders">
                        Reverb: <input type="range" id="delaySlider" min="0.0" max="1.0" value="0" step="0.1"> <span id="delayLabel">0</span>
                    </section>
                    <!--BRIGHTNESS SLIDER-->
                    <section class="sliders">
                        Distortion: <input type="range" id="distortSlider" min="0" max="1" value="0" step="0.01"> <span id="distortLabel">???</span>
                    </section>
                </section>

                <!--CHECKBOXES-->
                <section class="effectBox">
                    <span>Visual Effects</span>

                    <!--INVERT-->
                    <section class="checkbox">
                        Invert: <input type="checkbox" id="invert">
                    </section>
                    <!--SEPIA-->
                    <section class="checkbox">
                        Sepia: <input type="checkbox" id="sepia">
                    </section>
                    <!--NOISE-->
                    <section>
                        Noise: <input type="checkbox" id="noise">
                    </section>
                </section>

                <!--RADIO BUTTONS-->
                <section class="effectBox">
                    <span>Pride Colors</span>
                    <!--GAY-->
                    <section class="radio">
                        Gay: <input type="radio" name="pride" value="pan">
                    </section>
                    <!--LESBIAN-->
                    <section class="radio">
                        Lesbian: <input type="radio" name="pride" value="pan">
                    </section>
                    <!--BI-->
                    <section class="radio">
                        Bisexual: <input type="radio" name="pride" value="bi">
                    </section>
                    <!--PAN-->
                    <section class="radio">
                        Pansexual: <input type="radio" name="pride" value="pan">
                    </section>
                    <!--ACE-->
                    <section class="radio">
                        Asexual: <input type="radio" name="pride" value="pan">
                    </section>

                    <!--MAKE IT GAY-->
                    <section>
                        <button>Make it Gay</button>
                    </section>
                </section>
            </div>
        </div>
    </div>
</body>

</html>
